name: Build + test + run on Linux in container - x86-64/arm64

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

env:
  BUILD_TYPE: Debug
  BUILD_DIR: build
  BUILD_RELEASE_DIR: build-release
  GCC_DEBUG_PRESET: linux-debug-GNU
  CLANG_DEBUG_PRESET: linux-debug-clang
  GCC_PROFILE_PRESET: linux-profile-GNU
  CLANG_PROFILE_PRESET: linux-profile-clang
  CLANG_RELEASE_PRESET: linux-release-clang
  COVERAGE_JSON: coverage.json
  DOCS_OUT: build/build/html
  CONTAINER_IMAGE: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
  CLANG_GCC_TOOLCHAIN: /opt/gcc-15.2.0

jobs:
  build:
    strategy:
      matrix:
        include:
          - runs_on: ubuntu-24.04
            arch: x64
            platform: linux/amd64
            compiler: gcc
          - runs_on: ubuntu-24.04
            arch: x64
            platform: linux/amd64
            compiler: clang
          - runs_on: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64
            compiler: gcc
          - runs_on: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64
            compiler: clang

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Free Disk Space on Host
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Login to GitHub Container Registry
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_PAT || github.token }}
        run: echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull container image
        run: |
          for i in 1 2 3; do
            echo "Attempt $i to pull container..."
            if timeout 900 docker pull "${{ env.CONTAINER_IMAGE }}"; then
              echo "Successfully pulled container"
              exit 0
            fi
            echo "Pull failed, waiting before retry..."
            sleep 30
          done
          echo "Failed to pull container after 3 attempts"
          exit 1

      - name: Build + test + coverage + analyzers (in container)
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -e CLANG_GCC_TOOLCHAIN="${{ env.CLANG_GCC_TOOLCHAIN }}" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            "${{ env.CONTAINER_IMAGE }}" \
            bash /workspace/scripts/linux/build_test_coverage_analyzers.sh \
            --compiler "${{ matrix.compiler }}" \
            --build-dir "${{ env.BUILD_DIR }}" \
            --gcc-debug-preset "${{ env.GCC_DEBUG_PRESET }}" \
            --clang-debug-preset "${{ env.CLANG_DEBUG_PRESET }}" \
            --coverage-json "${{ env.COVERAGE_JSON }}"

      - name: Profiling + perf/bench (in container)
        continue-on-error: true
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -e CLANG_GCC_TOOLCHAIN="${{ env.CLANG_GCC_TOOLCHAIN }}" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            "${{ env.CONTAINER_IMAGE }}" \
            bash /workspace/scripts/linux/profiling_perf_bench.sh \
            --compiler "${{ matrix.compiler }}" \
            --build-dir "${{ env.BUILD_DIR }}" \
            --gcc-profile-preset "${{ env.GCC_PROFILE_PRESET }}" \
            --clang-profile-preset "${{ env.CLANG_PROFILE_PRESET }}"

      - name: Build docs + convert results (in container)
        if: ${{ matrix.compiler == 'clang' && matrix.runs_on == 'ubuntu-24.04' }}
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -e CLANG_GCC_TOOLCHAIN="${{ env.CLANG_GCC_TOOLCHAIN }}" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            "${{ env.CONTAINER_IMAGE }}" \
            bash /workspace/scripts/linux/build_docs_convert_results.sh \
            --docs-out "${{ env.DOCS_OUT }}"

      - name: Fix permissions for docs directory
        if: ${{ matrix.compiler == 'clang' && matrix.runs_on == 'ubuntu-24.04' }}
        run: |
          chmod -R 755 ./docs
          ls -la ./docs

      - name: Sync files to domain
        if: ${{ matrix.compiler == 'clang' && matrix.runs_on == 'ubuntu-24.04' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PW }}
          local-dir: "./docs/build/html/"

      - name: Release build + package + callgrind (in container)
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -e CLANG_GCC_TOOLCHAIN="${{ env.CLANG_GCC_TOOLCHAIN }}" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            "${{ env.CONTAINER_IMAGE }}" \
            bash /workspace/scripts/linux/release_package_callgrind.sh \
            --build-release-dir "${{ env.BUILD_RELEASE_DIR }}" \
            --clang-release-preset "${{ env.CLANG_RELEASE_PRESET }}"

      - name: Upload Linux Packages (Clang only)
        if: ${{ matrix.compiler == 'clang' }}
        uses: actions/upload-artifact@v6.0.0
        with:
          name: linux-packages-${{ matrix.arch }}
          path: |
            ${{ env.BUILD_RELEASE_DIR }}/*.tar.gz
            ${{ env.BUILD_RELEASE_DIR }}/*.tgz
            ${{ env.BUILD_RELEASE_DIR }}/*.deb
