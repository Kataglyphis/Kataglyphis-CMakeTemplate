#!/usr/bin/env bash
set -euo pipefail

SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/common.sh
source "${SELF_DIR}/lib/common.sh"
init_repo_context

DOCS_OUT="build/build/html"

log_info() {
  printf "\n[INFO] %s\n" "$1"
}

log_warn() {
  printf "\n[WARN] %s\n" "$1"
}

normalize_markdown_report() {
  local file_path="$1"
  python3 - "$file_path" <<'PY'
import pathlib
import re
import sys

path = pathlib.Path(sys.argv[1])
content = path.read_text(encoding="utf-8")
lines = content.splitlines()

filtered = []
for line in lines:
    stripped = line.strip()
    if re.match(r"^</?div(?:\s+[^>]*)?>$", stripped):
        continue
    if re.match(r"^<span\s+id=\"[^\"]+\"></span>$", stripped):
        continue
    if stripped == "Generated by junit2html":
        continue
    filtered.append(line)

normalized = "\n".join(filtered)
normalized = re.sub(r"\n{3,}", "\n\n", normalized).strip() + "\n"
path.write_text(normalized, encoding="utf-8")
PY
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --docs-out)
      [[ $# -ge 2 ]] || { echo "Missing value for --docs-out"; exit 1; }
      DOCS_OUT="$2"
      shift 2
      ;;
    *)
      echo "Unknown argument: $1"
      exit 1
      ;;
  esac
done

if ! command -v uv >/dev/null 2>&1; then
  echo "Error: uv is required but not installed."
  exit 1
fi

log_info "Preparing Python environment"
uv venv --allow-existing .venv
. ".venv/bin/activate"
uv pip install -r requirements.txt

DOCS_SOURCE_DIR="${REPO_ROOT}/docs/source"
DOCS_DIR="${REPO_ROOT}/docs"
DOCS_TEST_RESULTS_DIR="${DOCS_DIR}/test-results"
DOCS_TEST_RESULTS_MD_DIR="${DOCS_DIR}/test-results-md"
DOCS_SOURCE_TEST_RESULTS_DIR="${DOCS_SOURCE_DIR}/test-results"
DOCS_SOURCE_COVERAGE_DIR="${DOCS_SOURCE_DIR}/coverage"
SITE_RAW_TEST_RESULTS_DIR="${WORKSPACE_ROOT}/docs/build/html/test-results-raw"
SHARED_DOCS_KIT_DIR="${REPO_ROOT}/ExternalLib/Kataglyphis-ContainerHub/docs/source_templates/sphinx-book"

mkdir -p "${DOCS_SOURCE_DIR}/_static" "${DOCS_TEST_RESULTS_DIR}" "${DOCS_TEST_RESULTS_MD_DIR}"
mkdir -p "${DOCS_SOURCE_DIR}/_static/css"

if [[ "${SKIP_SHARED_THEME_SYNC:-false}" != "true" ]]; then
  if [[ -f "${SHARED_DOCS_KIT_DIR}/custom.css" ]]; then
    cp "${SHARED_DOCS_KIT_DIR}/custom.css" "${DOCS_SOURCE_DIR}/_static/css/custom.css"
    log_info "Synchronized shared docs theme from ContainerHub"
  else
    log_warn "Shared docs theme not found at ${SHARED_DOCS_KIT_DIR}; keeping local CSS"
  fi
fi

if compgen -G "${DOCS_OUT}/*.svg" >/dev/null; then
  cp "${DOCS_OUT}"/*.svg "${DOCS_SOURCE_DIR}/_static/"
fi

shopt -s globstar nullglob
log_info "Converting JUnit XML to HTML"

search_roots=(
  "${WORKSPACE_ROOT}/docs"
  "${WORKSPACE_ROOT}/build/Testing"
  "${WORKSPACE_ROOT}/Test"
)

xml_files=()
for root in "${search_roots[@]}"; do
  [[ -d "${root}" ]] || continue
  while IFS= read -r -d '' file; do
    xml_files+=("${file}")
  done < <(find "${root}" -type f -name "*.xml" -print0)
done

if [[ ${#xml_files[@]} -eq 0 ]]; then
  log_warn "No XML files found in expected test result directories."
fi

for f in "${xml_files[@]}"; do
  [ -s "$f" ] || { log_warn "Skipping empty file: $f"; continue; }
  if grep -qE "<testsuites|<testsuite" "$f"; then
    if junit2html "$f" "${DOCS_TEST_RESULTS_DIR}/$(basename "$f" .xml).html"; then
      echo "Converted: $(basename "$f")"
    else
      log_warn "junit2html failed for: $f â€” skipping"
    fi
  fi
done

if ! command -v pandoc >/dev/null 2>&1; then
  if command -v apt-get >/dev/null 2>&1 && [[ "$(id -u)" -eq 0 ]]; then
    log_info "Installing pandoc via apt-get"
    apt-get update
    apt-get install -y pandoc
  else
    log_warn "pandoc is not installed; skipping HTML -> Markdown conversion."
  fi
fi

html_files=("${DOCS_TEST_RESULTS_DIR}"/*.html)
if [ ${#html_files[@]} -eq 0 ]; then
  log_warn "No HTML files found in docs/test-results. Skipping pandoc conversion."
elif command -v pandoc >/dev/null 2>&1; then
  log_info "Converting HTML test reports to Markdown"
  for f in "${html_files[@]}"; do
    report_md="${DOCS_TEST_RESULTS_MD_DIR}/$(basename "$f" .html).md"
    pandoc "$f" -f html -t gfm -o "${report_md}"
    normalize_markdown_report "${report_md}"
  done
fi

mkdir -p "${DOCS_SOURCE_TEST_RESULTS_DIR}"
if [ -d "${DOCS_TEST_RESULTS_MD_DIR}" ] && [ "$(ls -A "${DOCS_TEST_RESULTS_MD_DIR}" || true)" ]; then
  cp -r "${DOCS_TEST_RESULTS_MD_DIR}"/* "${DOCS_SOURCE_TEST_RESULTS_DIR}/"
  log_info "Copied markdown test results to Sphinx source"
else
  log_warn "No markdown test results to copy (docs/test-results-md is empty or missing)"
fi

log_info "Updating test-results index"
{
  echo "Test Results"
  echo "============"
  echo
  echo "Modern, readable test reports generated from JUnit XML."
  echo
  echo ".. note::"
  echo ""
  echo "   Open the **Markdown report** for documentation-friendly navigation"
  echo "   or the **Raw HTML report** for the original junit2html rendering."
  md_found=0
  echo
  echo ".. grid:: 1 2 2 3"
  echo "   :gutter: 2"
  echo
  for report in "${DOCS_SOURCE_TEST_RESULTS_DIR}"/*.md; do
    [[ -f "${report}" ]] || continue
    report_base="$(basename "${report}" .md)"
    md_found=1
    echo "   .. grid-item-card:: ${report_base}"
    echo "      :class-card: sd-shadow-sm"
    echo ""
    echo "      - :doc:\`Markdown report <${report_base}>\`"
    echo "      - \`Raw HTML report <../test-results-raw/${report_base}.html>\`_"
    echo
  done

  echo ".. toctree::"
  echo "   :hidden:"
  echo ""
  for report in "${DOCS_SOURCE_TEST_RESULTS_DIR}"/*.md; do
    [[ -f "${report}" ]] || continue
    echo "   $(basename "${report}" .md)"
  done

  if [[ "${md_found}" -eq 0 ]]; then
    echo
    echo "No converted reports are available yet."
  fi
} > "${DOCS_SOURCE_TEST_RESULTS_DIR}/index.rst"

SITE_DIR="${WORKSPACE_ROOT}/docs/build/html"
mkdir -p "$SITE_DIR"
mkdir -p "${DOCS_SOURCE_COVERAGE_DIR}" "${DOCS_SOURCE_TEST_RESULTS_DIR}"

if [[ -d "${WORKSPACE_ROOT}/docs/coverage" ]]; then
  cp -r "${WORKSPACE_ROOT}/docs/coverage/." "${DOCS_SOURCE_COVERAGE_DIR}/"
  mkdir -p "$SITE_DIR/coverage"
  cp -r "${WORKSPACE_ROOT}/docs/coverage/." "$SITE_DIR/coverage/"
fi
if [[ -d "${DOCS_TEST_RESULTS_DIR}" ]]; then
  mkdir -p "$SITE_DIR/test-results"
  cp -r "${DOCS_TEST_RESULTS_DIR}/." "$SITE_DIR/test-results/"
fi

log_info "Refreshing generated API docs"
rm -rf "${DOCS_SOURCE_DIR}/api"

if command -v doxygen >/dev/null 2>&1; then
  log_info "Regenerating Doxygen XML"
  pushd "${REPO_ROOT}/build" >/dev/null
  doxygen "${REPO_ROOT}/Doxyfile.in"
  popd >/dev/null
else
  log_warn "doxygen is not installed; using existing XML output."
fi

log_info "Building Sphinx documentation"
pushd "${DOCS_SOURCE_DIR}" >/dev/null
uv run python graphviz_generator.py
popd >/dev/null
pushd "${DOCS_DIR}" >/dev/null
uv run make html
popd >/dev/null

if [[ -d "${DOCS_TEST_RESULTS_DIR}" ]]; then
  mkdir -p "${SITE_RAW_TEST_RESULTS_DIR}"
  for html_report in "${DOCS_TEST_RESULTS_DIR}"/*.html; do
    [[ -f "${html_report}" ]] || continue
    cp "${html_report}" "${SITE_RAW_TEST_RESULTS_DIR}/"
  done
  log_info "Published raw HTML test reports to ${SITE_RAW_TEST_RESULTS_DIR}"
fi

if [[ "$(id -u)" -eq 0 ]]; then
  OWNER_UID=$(stat -c "%u" "${WORKSPACE_ROOT}")
  OWNER_GID=$(stat -c "%g" "${WORKSPACE_ROOT}")
  log_info "Fixing ownership of docs/ to ${OWNER_UID}:${OWNER_GID}"
  chown -R "${OWNER_UID}:${OWNER_GID}" "${WORKSPACE_ROOT}/docs" || true
fi
